/**
 * @file build.js
 * @description
 * è¿™æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºâ€œæ²¹çŒ´è„šæœ¬â€ï¼ˆUserScriptï¼‰çš„ Node.js è„šæœ¬ã€‚
 *
 * å®ƒåšçš„äº‹æƒ…å¾ˆç®€å•ï¼š
 * 1. è¯»å– `src/main.js` æ–‡ä»¶ä½œä¸ºå…¥å£ï¼Œå¹¶ä½¿ç”¨ esbuild å°†å…¶æ‰€æœ‰ç›¸å…³çš„ä»£ç æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„JSæ–‡ä»¶ã€‚
 * 2. è¯»å– `src/header.txt` æ–‡ä»¶ï¼Œè¿™æ˜¯æ²¹çŒ´è„šæœ¬çš„å¤´éƒ¨ä¿¡æ¯ï¼Œç”¨äºè®© Tampermonkey/Greasemonkey ç­‰æ’ä»¶è¯†åˆ«è„šæœ¬ã€‚
 * 3. å°†å¤´éƒ¨ä¿¡æ¯å’Œæ‰“åŒ…åçš„JSä»£ç åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„è„šæœ¬æ–‡ä»¶ã€‚
 * 4. å°†è¿™ä¸ªæœ€ç»ˆæ–‡ä»¶è¾“å‡ºåˆ° `dist` æ–‡ä»¶å¤¹ä¸­ã€‚
 *
 * ---
 * å¦‚ä½•ä½¿ç”¨:
 * 1. ç¡®ä¿ä½ å·²ç»å®‰è£…äº† Node.js å’Œ npmã€‚
 * 2. åœ¨ç»ˆç«¯é‡Œè¿›å…¥è¿™ä¸ªé¡¹ç›®æ‰€åœ¨çš„æ–‡ä»¶å¤¹ã€‚
 * 3. è¿è¡Œ `npm install esbuild` æ¥å®‰è£…ä¾èµ–ã€‚
 * 4. è¿è¡Œ `node build.js` æ¥æ‰§è¡Œæ­¤è„šæœ¬ã€‚
 * ---
 */

// å¼•å…¥ esbuildï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¿«çš„ JavaScript æ‰“åŒ…å’Œå‹ç¼©å·¥å…·ã€‚
const esbuild = require('esbuild');
// å¼•å…¥ Node.js å†…ç½®çš„â€œæ–‡ä»¶ç³»ç»Ÿâ€æ¨¡å—ï¼ˆçš„ Promiseç‰ˆæœ¬ï¼‰ï¼Œç”¨äºè¯»å–å’Œå†™å…¥æ–‡ä»¶ã€‚
const fs = require('fs/promises');
// å¼•å…¥ Node.js å†…ç½®çš„â€œè·¯å¾„â€å¤„ç†æ¨¡å—ï¼Œç”¨äºå¤„ç†è·¨å¹³å°çš„æ–‡ä»¶è·¯å¾„é—®é¢˜ã€‚
const path = require('path');

/**
 * ä¸»æ„å»ºå‡½æ•°ï¼ŒåŒ…å«äº†æ‰€æœ‰çš„æ„å»ºé€»è¾‘ã€‚
 * ä½¿ç”¨ async/await æ¥å¤„ç†å¼‚æ­¥çš„æ–‡ä»¶æ“ä½œã€‚
 */
async function build() {
  try {
    // åœ¨ç»ˆç«¯æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œå‘Šè¯‰ç”¨æˆ·æ„å»ºå·²ç»å¼€å§‹ã€‚
    console.log('ğŸš€ å¼€å§‹æ„å»º...');

    // --- ç¬¬ä¸€æ­¥ï¼šä½¿ç”¨ esbuild åœ¨å†…å­˜ä¸­æ‰“åŒ…ä»£ç  ---
    const result = await esbuild.build({
      // entryPoints: æŒ‡å®šæ‰“åŒ…çš„å…¥å£æ–‡ä»¶ã€‚æˆ‘ä»¬çš„æ‰€æœ‰ä»£ç éƒ½ä»è¿™é‡Œå¼€å§‹ã€‚
      entryPoints: [path.join(__dirname, 'src/main.js')],
      // bundle: true, å¼€å¯æ‰“åŒ…æ¨¡å¼ã€‚esbuildä¼šåˆ†æä¾èµ–ï¼Œå¹¶æŠŠæ‰€æœ‰éœ€è¦çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªã€‚
      bundle: true,
      // ã€é‡è¦ã€‘write: false, è®¾ç½®ä¸º falseï¼Œesbuild ä¸ä¼šæŠŠç»“æœå†™å…¥ç¡¬ç›˜æ–‡ä»¶ï¼Œ
      // è€Œæ˜¯ä¼šæŠŠæ‰“åŒ…åçš„ä»£ç æ”¾åœ¨å†…å­˜ä¸­ï¼ˆresultå˜é‡é‡Œï¼‰ï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­æ·»åŠ å¤´éƒ¨ä¿¡æ¯ã€‚
      write: false,
      // charset: 'utf8', ç¡®ä¿è¾“å‡ºçš„æ–‡ä»¶ç¼–ç æ˜¯ UTF-8ï¼Œé˜²æ­¢ä¸­æ–‡ä¹±ç ã€‚
      charset: 'utf8',
    });

    // --- ç¬¬äºŒæ­¥ï¼šè¯»å–æ²¹çŒ´è„šæœ¬çš„å¤´éƒ¨ä¿¡æ¯ ---
    // ä» src/header.txt æ–‡ä»¶ä¸­è¯»å–å†…å®¹ã€‚è¿™äº›ä¿¡æ¯æ˜¯æ²¹çŒ´è„šæœ¬è¿è¡Œæ‰€å¿…éœ€çš„ã€‚
    const header = await fs.readFile(path.join(__dirname, 'src/header.txt'), 'utf-8');

    // --- ç¬¬ä¸‰æ­¥ï¼šå°†å¤´éƒ¨ä¿¡æ¯å’Œæ‰“åŒ…åçš„ä»£ç æ‹¼æ¥æˆæœ€ç»ˆè„šæœ¬ ---
    // ä» esbuild çš„å†…å­˜ç»“æœä¸­è·å–æ‰“åŒ…å¥½çš„ JavaScript ä»£ç ã€‚
    const bundledCode = result.outputFiles[0].text;
    // ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²å°† header å’Œ bundledCode ç»„åˆèµ·æ¥ã€‚ä¸­é—´åŠ ä¸¤ä¸ªæ¢è¡Œç¬¦ä»¥ä¿æŒæ ¼å¼æ¸…æ™°ã€‚
    const finalScript = `${header}\n\n${bundledCode}`;

    // --- ç¬¬å››æ­¥ï¼šåˆ›å»ºè¾“å‡ºç›®å½• ---
    // ç¡®ä¿ ./dist æ–‡ä»¶å¤¹å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»ºå®ƒã€‚
    // recursive: true å¯ä»¥é˜²æ­¢åœ¨æ–‡ä»¶å¤¹å·²å­˜åœ¨æ—¶æŠ¥é”™ã€‚
    await fs.mkdir(path.join(__dirname, 'dist'), { recursive: true });

    // --- ç¬¬äº”æ­¥ï¼šå°†æœ€ç»ˆçš„è„šæœ¬å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ ---
    // å°†æ‹¼æ¥å¥½çš„æœ€ç»ˆè„šæœ¬å†…å®¹å†™å…¥åˆ° dist/Web-Translate-Script.user.js æ–‡ä»¶ä¸­ã€‚
    await fs.writeFile(path.join(__dirname, 'dist/Web-Translate-Script.user.js'), finalScript);

    // åœ¨ç»ˆç«¯æ‰“å°æˆåŠŸæ¶ˆæ¯ï¼Œå¹¶å‘Šè¯‰ç”¨æˆ·äº§ç‰©åœ¨å“ªé‡Œã€‚
    console.log('âœ… æ„å»ºæˆåŠŸï¼æœ€ç»ˆè„šæœ¬ä½äº dist/Web-Translate-Script.user.js');

  } catch (error) {
    // å¦‚æœä¸Šé¢çš„ä»»ä½•ä¸€æ­¥å‡ºé”™äº†ï¼ˆæ¯”å¦‚æ–‡ä»¶æ‰¾ä¸åˆ°ã€ä»£ç æœ‰è¯­æ³•é”™è¯¯ç­‰ï¼‰ï¼Œå°±ä¼šåœ¨è¿™é‡Œæ•è·åˆ°é”™è¯¯ã€‚
    console.error('âŒ æ„å»ºå¤±è´¥:', error);
    // é€€å‡ºç¨‹åºï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ç ï¼ˆ1ï¼‰ï¼Œè¡¨ç¤ºæ„å»ºè¿‡ç¨‹å¼‚å¸¸ä¸­æ–­ã€‚
    process.exit(1);
  }
}

// è°ƒç”¨å¹¶æ‰§è¡Œä¸Šé¢çš„ build å‡½æ•°ï¼Œå¼€å§‹æ•´ä¸ªæ„å»ºè¿‡ç¨‹ã€‚
build();